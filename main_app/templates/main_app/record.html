<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Recorder</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .wrap {
            position: relative;
            width: 480px;
            height: 640px;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 24px 60px rgba(0, 0, 0, .45);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .line {
            position: absolute;
            top: 44%;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(0, 153, 255, .6);
        }

        .timer {
            position: absolute;
            top: 14px;
            right: 18px;
            color: #fff;
            font: 600 20px/1 Inter, system-ui;
            display: none;
        }

        .dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff3b30;
            margin-right: 8px;
        }

        /* ✨ Teleprompter box styling */
        .tp {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 92%;
            color: #ffffff;
            font-family: "Inter", system-ui, sans-serif;
            font-size: 1.3rem;
            line-height: 3rem;
            font-weight: 400;
            text-align: center;
            background: linear-gradient(180deg, rgba(0, 0, 0, .7), rgba(0, 0, 0, .3));
            padding: 18px 20px;
            border-radius: 10px;
            pointer-events: none;
            top: 60%;
            white-space: pre-wrap;
        }

        .circle {
            position: absolute;
            bottom: 26px;
            left: 50%;
            transform: translateX(-50%);
            width: 76px;
            height: 76px;
            border-radius: 50%;
            background: #ff3b30;
            border: 6px solid rgba(255, 255, 255, .85);
            cursor: pointer;
            transition: filter .2s, box-shadow .2s;
        }

        .armed {
            box-shadow: 0 0 0 6px rgba(255, 59, 48, .35), 0 0 24px rgba(255, 59, 48, .8);
        }
    </style>
</head>
<body>
<div class="wrap" id="wrap">
    <video id="pv" autoplay playsinline></video>
    <div class="line"></div>
    <div class="timer" id="tm"><span class="dot"></span><span id="ts">0:00</span></div>
    <!-- ✨ Teleprompter box with dynamic content -->
    <div class="tp" id="tp">{{ tele|default:"Text Not Found" }}</div>
    <button id="rec" class="circle" aria-label="record"></button>
</div>

<script>
    const v = document.getElementById('pv');
    const rec = document.getElementById('rec');
    const tp = document.getElementById('tp');

    // ✅ Load teleprompter text from localStorage (saved in step3) OR use Django template variable
    const savedText = localStorage.getItem('teleprompterText');
    const djangoText = "{{ tele|escapejs }}"; // Django variable

    // Use Django text if available, otherwise fallback to localStorage
    tp.textContent = djangoText && djangoText.trim() !== '' && djangoText !== 'Text Not Found'
        ? djangoText
        : (savedText && savedText.trim() !== '' ? savedText : 'Text Not Found');

    const tmBox = document.getElementById('tm');
    const ts = document.getElementById('ts');
    let mr, chunks = [], state = 'idle', scrollInt, tInt, t0;

    // ✅ Use safer, cross-browser codec
    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(s => {
        v.srcObject = s;

        const options = { mimeType: 'video/webm;codecs=vp8,opus' };
        mr = new MediaRecorder(s, options);

        mr.ondataavailable = e => chunks.push(e.data);

        mr.onstop = () => {
            clearInterval(scrollInt);
            clearInterval(tInt);
            tmBox.style.display = 'none';
            tp.style.top = '64%';

            const blob = new Blob(chunks, { type: 'video/webm' });
            chunks = [];

            const fd = new FormData();
            fd.append('video', blob, 'recording.webm');

            // ✅ Include career_cast_id from localStorage
            const castId = localStorage.getItem('current_cast_id');
            if (castId) {
                fd.append('career_cast_id', castId);
            }

            // Show uploading message
            ts.textContent = 'Uploading...';
            tmBox.style.display = 'block';

            fetch('/video/upload/', {
                method: 'POST',
                body: fd,
                headers: {
                    'X-CSRFToken': getCSRF()
                }
            })
                .then(r => {
                    if (!r.ok) throw new Error('Upload failed');
                    return r.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        console.log('Upload success:', data);
                        window.location.href = `/final-result/${data.cast_id}/`;
                    } else {
                        console.error('Upload error:', data.message);
                        alert('Upload failed: ' + data.message);
                        window.location.href = '/create-cast/step3/';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Upload failed. Please try again.');
                    window.location.href = '/create-cast/step3/';
                });
        };
    }).catch(error => {
        console.error('Error accessing camera/microphone:', error);
        alert('Cannot access camera/microphone. Please check permissions.');
    });

    function getCSRF() {
        const m = document.cookie.match(/csrftoken=([^;]+)/);
        return m ? decodeURIComponent(m[1]) : '';
    }

    // ✨ Teleprompter scroll animation
    function startScroll() {
        let y = 50;
        scrollInt = setInterval(() => {
            y -= 0.25;
            tp.style.top = y + '%';
            if (y < -50) clearInterval(scrollInt);
        }, 60);
    }

    // ⏱️ Timer display
    function startTimer() {
        tmBox.style.display = 'block';
        t0 = Date.now();
        tInt = setInterval(() => {
            const s = Math.floor((Date.now() - t0) / 1000);
            const m = Math.floor(s / 60);
            const ss = String(s % 60).padStart(2, '0');
            ts.textContent = `${m}:${ss}`;
        }, 1000);
    }

    // 🎥 Recording control button logic
    rec.addEventListener('click', () => {
        if (state === 'idle') {
            rec.classList.add('armed');
            state = 'armed';
        } else if (state === 'armed') {
            try {
                mr.start();
                startScroll();
                startTimer();
                rec.classList.remove('armed');
                rec.style.filter = 'grayscale(40%)';
                state = 'recording';
            } catch (error) {
                console.error('Error starting recording:', error);
                alert('Error starting recording. Please try again.');
            }
        } else if (state === 'recording') {
            rec.style.filter = '';
            mr.stop();
            state = 'idle';
        }
    });

    // 📝 Allow script updates (teleprompter text)
    window.addEventListener('message', e => {
        if (e.data.type === 'script') {
            tp.textContent = e.data.text && e.data.text.trim() !== ''
                ? e.data.text
                : 'Text Not Found';
        }
    });

    // ⚠️ Handle page refresh during recording
    window.addEventListener('beforeunload', e => {
        if (state === 'recording') {
            mr.stop();
            const msg = 'You are currently recording. Are you sure you want to leave?';
            e.returnValue = msg;
            return msg;
        }
    });
</script>


</body>
</html>
